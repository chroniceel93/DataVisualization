<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/static/style.css" />

  <script src="{{ url_for('static', filename='chart.js') }}"></script>
  <script src="{{ url_for('static', filename='jquery.js') }}"></script>
  <script src="{{ url_for('static', filename='allfunctions.js') }}"></script>

</head>
<body>

<h3>Line Graph Page</h3>
<button class="logoutbutton" onclick="location.href = '/login'">Logout</button><br>
<button class="button" onclick="location.href = '/'">Back</button>

<!-- Dropdown with table choices -->
<select id="tables" onchange="displayColumnDropdown(value)">
  <option> Select a table </option>  
</select>

<script>
  // jinja substitutes the scripts root directory upon creation.
  $SCRIPT_ROOT = {{ request.script_root|tojson }};

  // global variables
  var columnChoices = [];
  var tableChoices = [];
  
  var chosenTable;
  var chosenX;
  var chosenY;
  var chosenYType;
  

  var tableDropdown = document.getElementById("tables");

  // pass by reference
  getTables(tableChoices);

  // on page load, automatically display table dropdown
  displayTableDropdown(); 


  // gets tables from raw JSON data
  // passing by reference with global vars, but might need to change this - Arrays are weird in JS
  // CLEAN: clean this up by figuring out better way to pass value out (instead of global variable reference)
  function getTables(tableChoices) {
    var currentTable;

    // this used to be .getJSON, but now have syncronous option
    $.ajax({
      url: $SCRIPT_ROOT + '/db_all',
      dataType: 'json',
      async: false,
      //data: myData, // maybe should be '/db_all'?
      success: function(JSON) {

        // loop through JSON object and create array with unique table names
        // ASSUMES: first element of 2d array is table name, second is column name
        for (var i = 0, len = JSON.length; i < len; i++) {
          currentTable = JSON[i][0];
          var inTables = (tableChoices.indexOf(currentTable) > -1);

          // if currentTable is not already in tables,
          if (!inTables)
            tableChoices.push(currentTable); // add it to tables
        }
      }
    });

  }
  
  
  // displays elements of tableChoices in tableDropdown element
  // CLEAN: figure out how generalize this function by passing in a parameter
  function displayTableDropdown() {
    for (var i = 0; i < tableChoices.length; i++) {
      var optn = tableChoices[i];
      var el = document.createElement("option");
      el.textContent = optn;
      el.value = optn;

      tableDropdown.appendChild(el);
    }
  }
</script>


<!-- Column dropdowns, dependent on what table user chooses-->
<select id="xColumn" onchange = "chooseX(value)">
  <option> Select x-axis </option>  
</select>

<select id="yColumn" onchange = 'chooseY(value)'>
  <option> Select y-axis </option>  
</select>

<!--- Keep track of current values, useful for debugging -->
<p id='table'></p>
<p id = 'columnX'></p>
<p id = 'columnY'></p>
<p id = 'columnYType'></p>


<button onclick = 'graph(chosenTable, chosenX, chosenY, chosenYType)'> Update Values </button>


<script>
  var xColumn = document.getElementById("xColumn");
  var yColumn = document.getElementById("yColumn");

  // when user chooses x-axis
  function chooseX(x) {
    chosenX = x; // update global variable
    document.getElementById('columnX').innerHTML = "Current x-axis - " + x; // update html
  }

  // when user chooses y-axis
  function chooseY(y) {
    // set global variables
    chosenY = y; 
    getType(y);

    // update html
    document.getElementById('columnY').innerHTML = "Current y-axis - " + y; 
    document.getElementById('columnYType').innerHTML = "Current y type - " + chosenYType;
  }

  // displays column dropdown from columnChoices
  // TODO: modify to erase previous dropdown before displaying new one
  function displayColumnDropdown(table) {

    document.getElementById('table').innerHTML = "Current table - " + table;

    getColumns(table, columnChoices); // assigns appropriate columns to columnChoices
    chosenTable = table; // sets global var

    // loops over columns from db, adding those that correspond to table
    // CLEAN: don't know why need elx and ely separately, but it works
    for (var i = 0; i < columnChoices.length; i++) {
      var optn = columnChoices[i];

      var elx = document.createElement("option");
      elx.textContent = optn;
      elx.value = optn;

      var ely = document.createElement("option");
      ely.textContent = optn;
      ely.value = optn;

      yColumn.appendChild(elx);
      xColumn.appendChild(ely);
    }
  }


  // returns list of columns associated with given table name
  // CLEAN: eliminate passing in global variable
  function getColumns(tableName, columnChoices) {
    $.ajax({
      url: $SCRIPT_ROOT + '/db_all',
      dataType: 'json',
      async: false,
      success: function(JSON) {
        var currentTable;
        var currentColumn;
  
        // loop through JSON object and grab column names associated with given table name
        // ASSUMES: first element of 2d array is table name, second is column name
        for (var i = 0, len = JSON.length; i < len; i++) {
          currentTable = JSON[i][0];
          currentColumn = JSON[i][1];
  
          // if table name matches
          if (tableName == currentTable) {
            columnChoices.push(currentColumn);
          }
        }
      }
    });
  }

  
  // returns type associated with column passed in
  // CLEAN: use something other than global variable
  function getType(y) {
    $.ajax({
      url: $SCRIPT_ROOT + '/db_all',
      dataType: 'json',
      async: false,
      success: function(JSON) {
        var currentColumn;
        var currentType;

        // loop through JSON object and grab column type associated with chosen column
        // ASSUMES: third element of 2d array is column type
        for (var i = 0, len = JSON.length; i < len; i++) {
          currentColumn = JSON[i][1];
          currentType = JSON[i][2];

          // if column name matches
          if (chosenY == currentColumn)
            chosenYType = currentType;
        }
      }
    });
  }


  // type: -1 for no operation (disables step), 0 for avg, 1 for sum
  function graph(chosenTable, chosenX, chosenY, chosenYType) {

    // construct strings for sql queries
    var A = chosenTable + "," + chosenX;
    var B = chosenTable + "," + chosenY + "," + chosenYType;

    // requests appropriate data
    $.post($SCRIPT_ROOT + '/request', { type: 0, itemA: A, itemB: B, filter: "", step: 1 }, function(JSON) {
      var tmp = JSON.toString();
      var allVars = tmp.split(",");

      // gets odd values from array, which are x-vals
      var x = allVars.filter((element, index) => {
        return index % 2 === 1;
      });

      // gets even values from array, which are y-vals
      var y = allVars.filter((element, index) => {
        return index % 2 === 0;
      });

      // sets graph x-values to dates
      myChart.config.data.labels = x;

      // sets graph y-values to salaries
      myChart.config.data.datasets[0].data = y;

      
    }, "json");
  }


  function dropToggleColumn() {
    document.getElementById("setColumn").classList.toggle("show");
  }


  // Close the dropdown menu if the user clicks outside of it
  // Not sure if this is necessary?
  window.onclick = function(event) {
    if (!event.target.matches('.dropbtn')) {
      var dropdowns = document.getElementsByClassName("dropdown-content");
      var i;
      for (i = 0; i < dropdowns.length; i++) {
        var openDropdown = dropdowns[i];
        if (openDropdown.classList.contains('show')) {
          openDropdown.classList.remove('show');
        }
      }
    }
  }
</script>


<button onclick=updateGraph()> Graph </button>

<script>
  function updateGraph() {
    myChart.update();
  }
</script>


<div class="chartCard">
  <div class="chartBox">
    <canvas id="myChart"></canvas>
      Change name of graph: <input onkeyup="updatetitle(this)" type="text"><br>
      Change name of dataset: <input onkeyup="updatedatesetname1(this)" type="text"><br>
      Change max y axis: <input onkeyup="updateymax(this)" type="number"><br>
      Change min y axis: <input onkeyup="updateymin(this)" type="number"><br>
      Change name of x axis: <input onkeyup="updatexname(this)" type="text"><br>
      Change name of y axis: <input onkeyup="updateyname(this)" type="text"><br>
    <button class="button" onclick="exportimage()">Download Image</button>
    <button class="button" onclick="favgraph()">Favorite Graph</button>
    <button class="button" onclick="location.href = '/viewpage'">View Page</button><br>
    <button class="button" onclick="testRequest()"> Show request result </button>
  </div>
</div>


  <script>
    // jinja substitutes the scripts root directory upon creation.
    $SCRIPT_ROOT = {{ request.script_root|tojson }};



    // to be removed
    function testRequest() {
      $.post($SCRIPT_ROOT + '/request', { type: 0, itemA: "salaries,salary", itemB: "salaries,from_date,date", filter: "", step: 1 }, function(JSON) {
          var tmp = JSON.toString();
          var allVars = tmp.split(",");

          // gets odd values from array, which are dates
          var dates = tmp2.filter((element, index) => {
            return index % 2 === 1;
          });

          var evennums = tmp2.filter((element, index) => {
            return index % 2 === 0;
          });

          myChart.config.data.labels = dates;
          myChart.config.data.datasets[0].data = evennums;
          myChart.update();
      }, "json");
    }

    // setup 
    const data = {
      labels: [50,60,70,80,90,100,110,120,130,140,150],
      datasets: [{
        label: 'Line Graph Name',
        pointRadius: 4,
        backgroundColor: 'rgb(255, 255, 255)',
        pointBackgroundColor: "rgb(0,0,255)",
        data: [7,8,8,9,9,9,10,11,14,14,15]
      }]
    };

    //plugin
    const plugin = {
      id: 'custom_canvas_background_color',
      beforeDraw: (chart) => {
        const ctx = chart.canvas.getContext('2d');
        ctx.save();
        ctx.globalCompositeOperation = 'destination-over';
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, chart.width, chart.height);
        ctx.restore();
      }
    };

    // config 
    const config = {
      type: 'line',
      data,
      plugins: [plugin],
      options: {
        scales: {
            y: {
              title: {
                display: true,
                text: 'y axis'
              },
              suggestedMin: 0,
              suggestedMax: 20
            },
            x: {
              title: {
                display: true,
                text: 'x axis'
              },
              suggestedMin: 0,
              suggestedMax: 200
            }
        },
        plugins: {
          legend: {
              position: 'top',
          },
          title: {
              display: true,
              text: 'Line Graph'
          }
        }
      }
    };

    // render init block
    const myChart = new Chart(
      document.getElementById('myChart'),
      config
    );
  </script>

</body>
</html>